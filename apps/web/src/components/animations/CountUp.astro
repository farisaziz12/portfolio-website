---
/**
 * CountUp - Animated number counter (Astro version with viewport detection)
 * For stats always in viewport, use the React version with client:load
 */
interface Props {
  end: number;
  class?: string;
  duration?: number;
  delay?: number;
  suffix?: string;
  prefix?: string;
  decimals?: number;
}

const {
  end,
  class: className = '',
  duration = 2,
  delay = 0,
  suffix = '',
  prefix = '',
  decimals,
} = Astro.props;

const decimalPlaces = decimals !== undefined ? decimals : (end % 1 !== 0 ? (end.toString().split('.')[1]?.length || 0) : 0);
---

<span
  class:list={['count-up', className]}
  data-count-end={end}
  data-count-duration={duration}
  data-count-delay={delay}
  data-count-decimals={decimalPlaces}
>
  {prefix}<span class="count-value">0</span>{suffix}
</span>

<style>
  .count-up {
    display: inline-block;
    font-variant-numeric: tabular-nums;
  }
</style>

<script>
  // Simple self-initializing script for CountUp elements
  const elements = document.querySelectorAll<HTMLElement>('.count-up[data-count-end]');

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const target = entry.target as HTMLElement;
      if (entry.isIntersecting && !target.dataset.animated) {
        animateElement(target);
        target.dataset.animated = 'true';
        observer.unobserve(target);
      }
    });
  }, { threshold: 0.1 });

  function animateElement(el: HTMLElement) {
    const valueEl = el.querySelector('.count-value') as HTMLElement | null;
    if (!valueEl) return;

    const end = parseFloat(el.dataset.countEnd || '0');
    const duration = parseFloat(el.dataset.countDuration || '2') * 1000;
    const delay = parseFloat(el.dataset.countDelay || '0') * 1000;
    const decimals = parseInt(el.dataset.countDecimals || '0', 10);

    let start: number | null = null;

    function step(ts: number) {
      if (!start) start = ts;
      const progress = Math.min((ts - start) / duration, 1);
      const eased = 1 - Math.pow(2, -10 * progress);
      const value = eased * end;

      if (valueEl) {
        valueEl.textContent = decimals > 0
          ? value.toFixed(decimals)
          : Math.floor(value).toLocaleString();
      }

      if (progress < 1) {
        requestAnimationFrame(step);
      }
    }

    setTimeout(() => requestAnimationFrame(step), delay);
  }

  elements.forEach(el => observer.observe(el));
</script>

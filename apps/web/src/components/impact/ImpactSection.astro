---
/**
 * ImpactSection - Main container for impact metrics
 * Uses the new impactMetricV2 schema
 * Shows featured metrics with a CTA to the full /impact page
 */
import ImpactHero from './ImpactHero.astro';
import ScrollReveal from '../animations/ScrollReveal.astro';
import { sanityFetch } from '../../lib/sanity/client';
import { featuredImpactMetricsV2Query } from '../../lib/sanity/queries';

interface Props {
  variant?: 'homepage' | 'full';
  class?: string;
}

const {
  variant = 'homepage',
  class: className = '',
} = Astro.props;

// Types for V2 metrics
interface MetricV2 {
  _id: string;
  title: string;
  slug: string;
  domain: 'community' | 'product' | 'leadership' | 'speaking';
  headlineNumber: number;
  unit?: 'number' | 'k' | 'm' | 'percent' | 'x' | 'chf' | 'eur' | 'usd' | 'rating';
  prefix?: string;
  label: string;
  timeWindow?: string;
  delta?: string;
  contextNote?: string;
  confidenceSource?: string;
  highlightColor?: 'indigo' | 'violet' | 'emerald' | 'amber' | 'pink' | 'blue';
  featured?: boolean;
}

// Fetch featured V2 metrics
const featuredMetrics = await sanityFetch<MetricV2[]>(featuredImpactMetricsV2Query).catch(() => []);
const hasContent = featuredMetrics.length > 0;
---

{hasContent && (
  <section class:list={['impact-section', className]}>
    {/* Animated background */}
    <div class="impact-bg">
      <div class="impact-grid-lines"></div>
      <div class="impact-glow impact-glow--1"></div>
      <div class="impact-glow impact-glow--2"></div>
    </div>

    <div class="container relative z-10 py-16 md:py-20">
      {/* Header */}
      <div class="text-center mb-12">
        <ScrollReveal animation="fade-up">
          <p class="text-accent font-mono text-sm tracking-wider uppercase mb-3">
            Measurable Results
          </p>
        </ScrollReveal>
        <ScrollReveal animation="fade-up" delay={0.1}>
          <h2 class="text-3xl md:text-5xl font-display font-bold text-ink mb-4">
            Impact by the <span class="impact-title-highlight">Numbers</span>
          </h2>
        </ScrollReveal>
        <ScrollReveal animation="blur" delay={0.2}>
          <p class="text-ink-muted text-base md:text-lg max-w-xl mx-auto">
            Real results from community building, engineering, and speaking
          </p>
        </ScrollReveal>
      </div>

      {/* Hero Metrics */}
      {featuredMetrics.length > 0 && (
        <div class="mb-12">
          <ImpactHero metrics={featuredMetrics} />
        </div>
      )}

      {/* CTA */}
      <ScrollReveal animation="fade-up" delay={0.3} class="mt-10 text-center">
        <a href="/impact" class="impact-cta group">
          <span class="impact-cta__text">Explore all metrics</span>
          <span class="impact-cta__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="impact-cta__shine"></span>
        </a>
      </ScrollReveal>
    </div>
  </section>
)}

<style>
  .impact-section {
    background: rgb(var(--surface-raised));
    position: relative;
    overflow: hidden;
  }

  /* Section borders */
  .impact-section::before,
  .impact-section::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgb(var(--edge-strong)), transparent);
  }

  .impact-section::before { top: 0; }
  .impact-section::after { bottom: 0; }

  /* Background effects */
  .impact-bg {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .impact-grid-lines {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(rgb(var(--accent) / 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgb(var(--accent) / 0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    mask-image: radial-gradient(ellipse at center, black 0%, transparent 70%);
  }

  .impact-glow {
    position: absolute;
    width: 400px;
    height: 400px;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.06;
    animation: impact-float 20s ease-in-out infinite;
  }

  .impact-glow--1 {
    top: -100px;
    right: -100px;
    background: rgb(16 185 129); /* emerald */
  }

  .impact-glow--2 {
    bottom: -100px;
    left: -100px;
    background: rgb(var(--accent));
    animation-delay: -10s;
  }

  @keyframes impact-float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(-30px, 20px) scale(1.05); }
    66% { transform: translate(20px, -30px) scale(0.95); }
  }

  .impact-title-highlight {
    background: linear-gradient(135deg, rgb(16 185 129), rgb(var(--accent)), rgb(168 85 247));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* CTA Button */
  .impact-cta {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: rgb(16 185 129 / 0.1);
    border: 1px solid rgb(16 185 129 / 0.3);
    border-radius: 9999px;
    color: rgb(var(--ink));
    font-weight: 600;
    font-size: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .impact-cta:hover {
    border-color: rgb(16 185 129 / 0.6);
    background: rgb(16 185 129 / 0.15);
    transform: translateY(-2px);
    box-shadow: 0 15px 30px -8px rgb(16 185 129 / 0.2);
  }

  .impact-cta__text {
    position: relative;
    z-index: 1;
  }

  .impact-cta__icon {
    position: relative;
    z-index: 1;
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s ease;
    color: rgb(16 185 129);
  }

  .impact-cta:hover .impact-cta__icon {
    transform: translateX(3px);
  }

  .impact-cta__shine {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgb(16 185 129 / 0.1), transparent);
    transition: left 0.5s ease;
  }

  .impact-cta:hover .impact-cta__shine {
    left: 100%;
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce) {
    .impact-glow {
      animation: none;
    }
  }
</style>

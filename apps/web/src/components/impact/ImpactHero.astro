---
/**
 * ImpactHero - Featured hero metrics display
 * Shows 3-6 large animated metrics for maximum impact
 * Updated to use impactMetricV2 schema
 */
import CountUp from '../islands/CountUp';
import SpotlightCard from '../animations/SpotlightCard.astro';
import ScrollReveal from '../animations/ScrollReveal.astro';

// V2 Metric type
interface MetricV2 {
  _id: string;
  title: string;
  slug: string;
  domain: 'community' | 'product' | 'leadership' | 'speaking';
  headlineNumber: number;
  unit?: 'number' | 'k' | 'm' | 'percent' | 'x' | 'chf' | 'eur' | 'usd' | 'rating';
  prefix?: string;
  label: string;
  timeWindow?: string;
  delta?: string;
  contextNote?: string;
  confidenceSource?: string;
  highlightColor?: 'indigo' | 'violet' | 'emerald' | 'amber' | 'pink' | 'blue';
  featured?: boolean;
}

interface Props {
  metrics: MetricV2[];
  class?: string;
}

const { metrics, class: className = '' } = Astro.props;

// Domain config with icons and labels
const DOMAIN_CONFIG: Record<string, { icon: string; label: string }> = {
  community: { icon: 'ðŸ‘¥', label: 'Community' },
  product: { icon: 'ðŸ’°', label: 'Product' },
  leadership: { icon: 'ðŸŽ¯', label: 'Leadership' },
  speaking: { icon: 'ðŸŽ¤', label: 'Speaking' },
};

// Helper to format metric number based on unit
function formatMetricNumber(value: number, unit?: string): { display: number; suffix: string } {
  switch (unit) {
    case 'k':
      return { display: value >= 1000 ? value / 1000 : value, suffix: value >= 1000 ? 'K' : '' };
    case 'm':
      return { display: value >= 1000000 ? value / 1000000 : value, suffix: value >= 1000000 ? 'M' : '' };
    case 'percent':
      return { display: value, suffix: '%' };
    case 'x':
      return { display: value, suffix: 'x' };
    case 'rating':
      return { display: value, suffix: '/5' };
    case 'chf':
    case 'eur':
    case 'usd':
      return { display: value, suffix: '' };
    default:
      return { display: value, suffix: '' };
  }
}

// Helper to get prefix for currency units
function getPrefix(unit?: string, prefix?: string): string {
  if (prefix) return prefix;
  switch (unit) {
    case 'chf': return 'CHF ';
    case 'eur': return 'â‚¬';
    case 'usd': return '$';
    default: return '';
  }
}

// Helper to get highlight color class
function getHighlightColor(color?: string): string {
  const colors: Record<string, string> = {
    indigo: 'text-indigo-500',
    violet: 'text-violet-500',
    pink: 'text-pink-500',
    emerald: 'text-emerald-500',
    amber: 'text-amber-500',
    blue: 'text-blue-500',
  };
  return colors[color || 'indigo'] || colors.indigo;
}

// Helper to get spotlight colors based on highlight
function getSpotlightColors(color?: string): { spotlight: string; border: string } {
  const colors: Record<string, { spotlight: string; border: string }> = {
    indigo: { spotlight: 'rgba(99, 102, 241, 0.15)', border: 'rgba(99, 102, 241, 0.5)' },
    violet: { spotlight: 'rgba(139, 92, 246, 0.15)', border: 'rgba(139, 92, 246, 0.5)' },
    pink: { spotlight: 'rgba(236, 72, 153, 0.15)', border: 'rgba(236, 72, 153, 0.5)' },
    emerald: { spotlight: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.5)' },
    amber: { spotlight: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.5)' },
    blue: { spotlight: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.5)' },
  };
  return colors[color || 'indigo'] || colors.indigo;
}
---

<div class:list={['impact-hero', className]}>
  <div class="impact-hero__grid">
    {metrics.map((metric, index) => {
      const highlightGradient = getHighlightColor(metric.highlightColor);
      const spotlightColors = getSpotlightColors(metric.highlightColor);
      const domainInfo = DOMAIN_CONFIG[metric.domain];
      const formatted = formatMetricNumber(metric.headlineNumber, metric.unit);
      const displayPrefix = getPrefix(metric.unit, metric.prefix);
      const isPositiveDelta = metric.delta?.startsWith('+') || metric.delta?.includes('â†‘');

      return (
        <ScrollReveal animation="fade-up" delay={index * 0.1}>
          <a href={`/impact?domain=${metric.domain}#metric=${metric.slug}`} class="block h-full">
            <SpotlightCard
              class="impact-hero__card"
              spotlightColor={spotlightColors.spotlight}
              borderColor={spotlightColors.border}
            >
              <div class="impact-hero__card-inner">
                {/* Domain badge */}
                <div class="impact-hero__category">
                  {domainInfo?.icon && (
                    <span class="impact-hero__category-icon">{domainInfo.icon}</span>
                  )}
                  <span class="impact-hero__category-label">{domainInfo?.label}</span>
                </div>

                {/* Main value */}
                <div class="impact-hero__value-wrapper">
                  <span class={`impact-hero__value ${highlightGradient}`}>
                    {displayPrefix && <span class="impact-hero__prefix">{displayPrefix}</span>}
                    <CountUp
                      client:visible
                      end={formatted.display}
                      duration={2}
                      delay={0.5 + index * 0.2}
                      className="impact-hero__number"
                    />
                    {formatted.suffix && <span class="impact-hero__suffix">{formatted.suffix}</span>}
                  </span>
                </div>

                {/* Label */}
                <div class="impact-hero__label-row">
                  <span class="impact-hero__label">{metric.label}</span>
                </div>

                {/* Delta chip + time window */}
                <div class="impact-hero__meta">
                  {metric.delta && (
                    <span class={`impact-hero__growth ${isPositiveDelta ? 'impact-hero__growth--positive' : 'impact-hero__growth--neutral'}`}>
                      {metric.delta}
                    </span>
                  )}
                  {metric.timeWindow && (
                    <span class="impact-hero__time">{metric.timeWindow}</span>
                  )}
                </div>

                {/* Context note */}
                {metric.contextNote && (
                  <div class="impact-hero__source">
                    <span>{metric.contextNote}</span>
                  </div>
                )}
              </div>
            </SpotlightCard>
          </a>
        </ScrollReveal>
      );
    })}
  </div>
</div>

<style>
  .impact-hero__grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  @media (max-width: 1024px) {
    .impact-hero__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .impact-hero__grid {
      grid-template-columns: 1fr;
    }
  }

  .impact-hero__card {
    height: 100%;
    min-height: 280px;
  }

  .impact-hero__card-inner {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-height: 280px;
  }

  .impact-hero__category {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.75rem;
    background: rgb(var(--surface-overlay));
    border: 1px solid rgb(var(--edge));
    border-radius: 9999px;
    width: fit-content;
  }

  .impact-hero__category-icon {
    font-size: 0.875rem;
  }

  .impact-hero__category-label {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgb(var(--ink-muted));
  }

  .impact-hero__value-wrapper {
    margin: 0.75rem 0;
  }

  .impact-hero__value {
    font-family: var(--font-display);
    font-size: 3.25rem;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -0.02em;
  }

  @media (max-width: 768px) {
    .impact-hero__value {
      font-size: 2.5rem;
    }
  }

  .impact-hero__prefix,
  .impact-hero__suffix {
    font-size: 0.6em;
  }

  .impact-hero__number {
    display: inline;
  }

  .impact-hero__label-row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.5rem;
  }

  .impact-hero__label {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 600;
    color: rgb(var(--ink));
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .impact-hero__unit {
    font-size: 0.875rem;
    color: rgb(var(--ink-faint));
  }

  .impact-hero__meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .impact-hero__growth {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .impact-hero__growth--positive {
    background: rgb(16 185 129 / 0.15);
    color: rgb(16 185 129);
  }

  .impact-hero__growth--negative {
    background: rgb(239 68 68 / 0.15);
    color: rgb(239 68 68);
  }

  .impact-hero__growth--neutral {
    background: rgb(var(--accent) / 0.15);
    color: rgb(var(--accent));
  }

  .impact-hero__time {
    font-size: 0.8rem;
    color: rgb(var(--ink-faint));
  }

  .impact-hero__source {
    margin-top: auto;
    padding-top: 0.75rem;
    border-top: 1px solid rgb(var(--edge));
    font-size: 0.75rem;
    color: rgb(var(--ink-faint));
  }

  .impact-hero__source-link {
    display: inline-flex;
    align-items: center;
    color: rgb(var(--ink-muted));
    transition: color 0.2s ease;
  }

  .impact-hero__source-link:hover {
    color: rgb(var(--accent));
  }
</style>

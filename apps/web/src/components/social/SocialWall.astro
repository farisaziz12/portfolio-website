---
import { urlFor } from '../../lib/sanity/client';
import SocialWallIsland from '../islands/SocialWallIsland';

interface SocialPost {
  _id: string;
  url: string;
  platform: 'linkedin' | 'twitter';
  author: string;
  authorHandle?: string;
  authorImage?: any;
  authorRole?: string;
  postImage?: any;
  content: string;
  tweetId?: string;
  postDate?: string;
  relatedTalk?: { title: string; slug: string };
  relatedEvent?: { title: string; slug: string; conference: string };
}

interface Testimonial {
  _id: string;
  quote: string;
  author: string;
  role?: string;
  company?: string;
  image?: any;
}

interface Props {
  posts: SocialPost[];
  testimonials?: Testimonial[];
}

const { posts, testimonials = [] } = Astro.props;

// Pre-process image URLs for the React component
const socialPostImages: Record<string, string> = {};
posts.forEach((post: SocialPost) => {
  if (post.authorImage) {
    socialPostImages[post._id] = urlFor(post.authorImage).width(48).height(48).url();
  }
});

const testimonialImages: Record<string, string> = {};
testimonials.forEach((testimonial: Testimonial) => {
  if (testimonial.image) {
    testimonialImages[testimonial._id] = urlFor(testimonial.image).width(48).height(48).url();
  }
});

// Transform posts for the React component (normalize the data)
const normalizedPosts = posts.map((post: SocialPost) => ({
  _id: post._id,
  platform: post.platform,
  author: post.author,
  authorRole: post.authorRole,
  authorHandle: post.authorHandle,
  content: post.content,
  url: post.url,
  postDate: post.postDate,
}));

const normalizedTestimonials = testimonials.map((t) => ({
  _id: t._id,
  quote: t.quote,
  author: t.author,
  role: t.role,
  company: t.company,
}));
---

<section class="social-wall py-20 md:py-28 overflow-hidden relative">
  {/* Background effects */}
  <div class="absolute inset-0 bg-gradient-to-b from-surface via-surface-overlay/50 to-surface pointer-events-none"></div>
  <div class="absolute inset-0 dot-pattern opacity-30 pointer-events-none"></div>

  <div class="container relative z-10">
    {/* Header */}
    <div class="text-center mb-16">
      <div class="inline-flex items-center gap-2 px-4 py-2 bg-accent/10 border border-accent/20 rounded-full text-accent text-sm font-medium mb-6">
        <span class="relative flex h-2 w-2">
          <span class="relative inline-flex rounded-full h-2 w-2 bg-accent"></span>
        </span>
        From the community
      </div>
      <h2 class="heading-2 mb-4">
        What People <span class="text-gradient">Say</span>
      </h2>
      <p class="text-ink-muted text-lg max-w-xl mx-auto mb-6">
        Real reactions from conferences, meetups, and colleagues
      </p>
      <a href="/appreciation" class="view-all-link">
        View all mentions
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>

    {/* React Island for Interactive Social Wall */}
    <SocialWallIsland
      client:load
      posts={normalizedPosts}
      testimonials={normalizedTestimonials}
      socialPostImages={socialPostImages}
      testimonialImages={testimonialImages}
    />

    {/* Floating particles */}
    <div class="social-particles" aria-hidden="true">
      <div class="particle particle-1"></div>
      <div class="particle particle-2"></div>
      <div class="particle particle-3"></div>
      <div class="particle particle-4"></div>
      <div class="particle particle-5"></div>
    </div>
  </div>
</section>

<style>
  .social-wall {
    --accent-rgb: 99, 102, 241;
  }

  .dot-pattern {
    background-image: radial-gradient(circle, var(--edge) 1px, transparent 1px);
    background-size: 24px 24px;
  }

  .view-all-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent);
    font-weight: 500;
    text-decoration: none;
    transition: gap 0.2s ease;
  }

  .view-all-link:hover {
    gap: 0.75rem;
  }

  .view-all-link svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* Floating Particles */
  .social-particles {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
  }

  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    opacity: 0.4;
  }

  .particle-1 {
    top: 20%;
    left: 10%;
    animation: float-particle 8s ease-in-out infinite;
  }

  .particle-2 {
    top: 60%;
    left: 85%;
    animation: float-particle 10s ease-in-out infinite reverse;
    background: var(--violet-500, #8b5cf6);
  }

  .particle-3 {
    top: 80%;
    left: 30%;
    animation: float-particle 7s ease-in-out infinite 1s;
    background: var(--pink-500, #ec4899);
  }

  .particle-4 {
    top: 30%;
    left: 70%;
    animation: float-particle 9s ease-in-out infinite 0.5s;
  }

  .particle-5 {
    top: 50%;
    left: 5%;
    animation: float-particle 11s ease-in-out infinite 2s;
    background: var(--emerald-500, #10b981);
  }

  @keyframes float-particle {
    0%, 100% {
      transform: translate(0, 0) scale(1);
      opacity: 0.4;
    }
    25% {
      transform: translate(30px, -20px) scale(1.2);
      opacity: 0.6;
    }
    50% {
      transform: translate(-20px, -40px) scale(0.8);
      opacity: 0.3;
    }
    75% {
      transform: translate(10px, -10px) scale(1.1);
      opacity: 0.5;
    }
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce) {
    .particle {
      animation: none;
    }
  }
</style>

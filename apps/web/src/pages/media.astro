---
import BaseLayout from '../layouts/BaseLayout.astro';
import ScrollReveal from '../components/animations/ScrollReveal.astro';
import SpotlightCard from '../components/animations/SpotlightCard.astro';
import { sanityFetch, urlFor } from '../lib/sanity/client';
import { allMediaQuery } from '../lib/sanity/queries';
import { formatDate, getCountryFlag } from 'shared/utils';

interface MediaItem {
  _id: string;
  title?: string;
  type: string;
  image?: any;
  videoUrl?: string;
  date?: string;
  location?: {
    city?: string;
    country?: string;
  };
  description?: string;
  event?: {
    _id: string;
    title: string;
    slug: string;
  };
  credit?: string;
  featured?: boolean;
}

const media = await sanityFetch<MediaItem[]>(allMediaQuery).catch(() => []);

// Group media by type
const photos = media.filter((m) => m.type === 'photo');
const videos = media.filter((m) => m.type === 'video');
const press = media.filter((m) => m.type === 'press');
---

<BaseLayout
  title="Media | Faris Aziz"
  description="Photos, videos, and press coverage from Faris Aziz's speaking engagements at conferences and meetups around the world."
  pathname="/media"
>
  <!-- Hero Section -->
  <section class="relative min-h-[50vh] flex items-center overflow-hidden">
    <div class="absolute inset-0 grid-pattern opacity-50"></div>
    <div class="absolute inset-0 gradient-mesh"></div>

    <div class="container relative z-10 py-20 md:py-28">
      <div class="max-w-4xl">
        <ScrollReveal>
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-accent/10 rounded-full text-accent text-sm font-medium mb-6">
            <span class="text-xl">ðŸ“¸</span>
            Gallery
          </div>
        </ScrollReveal>

        <ScrollReveal delay={0.1}>
          <h1 class="hero-title mb-6" transition:name="page-title">
            <span class="block text-ink">Media</span>
            <span class="block hero-title--gradient">Gallery</span>
          </h1>
        </ScrollReveal>

        <ScrollReveal delay={0.2}>
          <p class="text-xl md:text-2xl text-ink-muted max-w-2xl">
            Photos and videos from conferences, meetups, and speaking engagements around the world.
          </p>
        </ScrollReveal>
      </div>
    </div>
  </section>

  {media.length > 0 ? (
    <>
      <!-- Videos Section -->
      {videos.length > 0 && (
        <section class="section py-16 md:py-24 bg-surface-overlay/50">
          <div class="container">
            <div class="text-center mb-12">
              <ScrollReveal>
                <h2 class="heading-2 mb-4">Talk Recordings</h2>
              </ScrollReveal>
              <ScrollReveal delay={0.1}>
                <p class="text-ink-muted text-lg max-w-2xl mx-auto">
                  Watch recordings of my presentations
                </p>
              </ScrollReveal>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {videos.map((item: MediaItem, index: number) => (
                <ScrollReveal delay={0.1 * index}>
                  <a
                    href={item.videoUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group block h-full"
                  >
                    <SpotlightCard class="h-full overflow-hidden">
                      <div class="aspect-video bg-surface-overlay relative">
                        {item.image ? (
                          <img
                            src={urlFor(item.image).width(800).height(450).quality(90).url()}
                            alt={item.title || 'Video thumbnail'}
                            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                            loading="lazy"
                          />
                        ) : (
                          <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-accent/20 to-violet-500/20">
                            <svg class="w-16 h-16 text-ink-faint" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                          </div>
                        )}
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                          <div class="w-16 h-16 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                            <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                          </div>
                        </div>
                      </div>
                      <div class="p-5">
                        <h3 class="font-display font-semibold text-ink mb-2 group-hover:text-accent transition-colors line-clamp-2">
                          {item.title}
                        </h3>
                        {item.event && (
                          <p class="text-sm text-ink-muted mb-2">
                            {item.event.title}
                          </p>
                        )}
                        {item.date && (
                          <p class="text-xs text-ink-faint">
                            {formatDate(item.date, { month: 'short', year: 'numeric' })}
                          </p>
                        )}
                      </div>
                    </SpotlightCard>
                  </a>
                </ScrollReveal>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- Photos Section -->
      {photos.length > 0 && (
        <section class="section py-16 md:py-24">
          <div class="container">
            <div class="text-center mb-12">
              <ScrollReveal>
                <h2 class="heading-2 mb-4">Photos</h2>
              </ScrollReveal>
              <ScrollReveal delay={0.1}>
                <p class="text-ink-muted text-lg max-w-2xl mx-auto">
                  Snapshots from events around the world
                </p>
              </ScrollReveal>
            </div>

            <div class="photo-gallery">
              {photos.map((item: MediaItem, index: number) => (
                <ScrollReveal delay={0.05 * index}>
                  <div
                    class="photo-card group"
                    data-photo-index={index}
                    data-full-url={item.image ? urlFor(item.image).width(1600).quality(95).url() : ''}
                  >
                    {item.image && (
                      <button class="photo-card__image" aria-label="View full size">
                        <img
                          src={urlFor(item.image).width(600).height(600).quality(90).url()}
                          alt={item.title || 'Event photo'}
                          loading="lazy"
                        />
                        <div class="photo-card__overlay">
                          <span class="photo-card__expand">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                            </svg>
                          </span>
                        </div>
                      </button>
                    )}
                    <div class="photo-card__info">
                      <div class="photo-card__meta">
                        <p class="photo-card__title">{item.title}</p>
                        {item.location && (
                          <p class="photo-card__location">
                            {getCountryFlag(item.location.country || '')} {item.location.city}
                          </p>
                        )}
                      </div>

                      {/* Mobile: Prominent download button */}
                      {item.image && (
                        <button
                          class="photo-card__download-mobile download-btn-mobile"
                          data-url={urlFor(item.image).width(1200).quality(95).url()}
                          data-filename={`event-photo-${index + 1}.jpg`}
                          aria-label="Download photo"
                        >
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                          </svg>
                          <span>Download</span>
                        </button>
                      )}

                      {/* Desktop: Icon button */}
                      {item.image && (
                        <button
                          class="photo-card__download-desktop"
                          data-url={urlFor(item.image).width(1200).quality(95).url()}
                          data-filename={`event-photo-${index + 1}.jpg`}
                          title="Download high-resolution"
                          aria-label="Download photo"
                        >
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                          </svg>
                        </button>
                      )}
                    </div>
                    {item.credit && (
                      <p class="photo-card__credit">ðŸ“· {item.credit}</p>
                    )}
                  </div>
                </ScrollReveal>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- Press Section -->
      {press.length > 0 && (
        <section class="section py-16 md:py-24 bg-surface-overlay/50">
          <div class="container">
            <div class="text-center mb-12">
              <ScrollReveal>
                <h2 class="heading-2 mb-4">Press & Features</h2>
              </ScrollReveal>
              <ScrollReveal delay={0.1}>
                <p class="text-ink-muted text-lg max-w-2xl mx-auto">
                  Articles and mentions
                </p>
              </ScrollReveal>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
              {press.map((item: MediaItem, index: number) => (
                <ScrollReveal delay={0.1 * index}>
                  <SpotlightCard class="h-full">
                    <div class="p-6 h-full flex flex-col">
                      <h3 class="font-display font-semibold text-ink mb-3">
                        {item.title}
                      </h3>
                      {item.description && (
                        <p class="text-sm text-ink-muted mb-4 line-clamp-3 flex-grow">
                          {item.description}
                        </p>
                      )}
                      {item.date && (
                        <p class="text-xs text-ink-faint">
                          {formatDate(item.date, { month: 'long', year: 'numeric' })}
                        </p>
                      )}
                    </div>
                  </SpotlightCard>
                </ScrollReveal>
              ))}
            </div>
          </div>
        </section>
      )}
    </>
  ) : (
    <section class="section py-20">
      <div class="container">
        <ScrollReveal>
          <div class="card p-12 text-center max-w-2xl mx-auto">
            <div class="text-5xl mb-6">ðŸ“·</div>
            <h3 class="heading-3 mb-4">Coming Soon</h3>
            <p class="text-ink-muted mb-6">
              Media content will appear here once added.
            </p>
            <a href="/speaking" class="btn-secondary inline-flex items-center gap-2">
              View speaking events
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        </ScrollReveal>
      </div>
    </section>
  )}

  <!-- Photo Lightbox -->
  <div class="photo-lightbox" id="photo-lightbox" aria-hidden="true">
    <button class="photo-lightbox__close" aria-label="Close lightbox">
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="photo-lightbox__prev" aria-label="Previous image">
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <button class="photo-lightbox__next" aria-label="Next image">
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
    <div class="photo-lightbox__content">
      <img class="photo-lightbox__image" src="" alt="Full size photo" />
    </div>
    <div class="photo-lightbox__footer">
      <span class="photo-lightbox__counter"></span>
      <button class="photo-lightbox__download" aria-label="Download photo">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        <span>Download</span>
      </button>
    </div>
  </div>

  <!-- CTA Section -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-accent via-violet-600 to-pink-600"></div>
    <div class="absolute inset-0 grid-pattern opacity-10"></div>

    <div class="container relative z-10 py-24 md:py-32">
      <div class="max-w-4xl mx-auto text-center">
        <ScrollReveal>
          <h2 class="text-3xl md:text-4xl font-display font-bold text-white mb-6">
            Want professional photos at your event?
          </h2>
        </ScrollReveal>
        <ScrollReveal delay={0.1}>
          <p class="text-white/80 text-lg mb-10 max-w-2xl mx-auto">
            I'm always happy to share professional photos and videos from events. Let's discuss how to capture great content together.
          </p>
        </ScrollReveal>

        <ScrollReveal delay={0.2}>
          <a
            href="/invite"
            class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-white text-violet-700 font-bold text-lg rounded-xl hover:bg-white/90 transition-all duration-200 hover:scale-105 active:scale-95 shadow-xl"
          >
            Get in touch
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </a>
        </ScrollReveal>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Photo Gallery */
  .photo-gallery {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .photo-gallery {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .photo-gallery {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Photo Card */
  .photo-card {
    background: rgb(var(--surface));
    border: 1px solid rgb(var(--edge));
    border-radius: 0.75rem;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .photo-card:hover {
    border-color: rgb(var(--edge-strong));
    transform: translateY(-2px);
  }

  .photo-card__image {
    position: relative;
    aspect-ratio: 1;
    width: 100%;
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
    display: block;
    overflow: hidden;
  }

  .photo-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .photo-card:hover .photo-card__image img {
    transform: scale(1.05);
  }

  .photo-card__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgb(0 0 0 / 0);
    transition: background 0.3s ease;
  }

  .photo-card:hover .photo-card__overlay {
    background: rgb(0 0 0 / 0.35);
  }

  .photo-card__expand {
    width: 2.75rem;
    height: 2.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 50%;
    color: rgb(var(--ink));
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s ease;
  }

  .photo-card:hover .photo-card__expand {
    opacity: 1;
    transform: scale(1);
  }

  .photo-card__info {
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  @media (min-width: 640px) {
    .photo-card__info {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .photo-card__meta {
    flex: 1;
    min-width: 0;
  }

  .photo-card__title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: rgb(var(--ink));
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .photo-card__location {
    font-size: 0.6875rem;
    color: rgb(var(--ink-faint));
    margin-top: 0.125rem;
  }

  .photo-card__credit {
    padding: 0 0.75rem 0.75rem;
    font-size: 0.625rem;
    color: rgb(var(--ink-faint));
  }

  /* Mobile Download Button */
  .photo-card__download-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    width: 100%;
    min-height: 2.75rem;
    padding: 0.625rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, rgb(var(--accent)), rgb(139 92 246));
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .photo-card__download-mobile:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgb(var(--accent) / 0.3);
  }

  .photo-card__download-mobile:active {
    transform: translateY(0);
  }

  /* Desktop Download Button */
  .photo-card__download-desktop {
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    flex-shrink: 0;
    color: rgb(var(--ink-muted));
    background: rgb(var(--surface-overlay));
    border: 1px solid rgb(var(--edge));
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .photo-card__download-desktop:hover {
    color: rgb(var(--accent));
    border-color: rgb(var(--accent) / 0.5);
    background: rgb(var(--accent) / 0.1);
  }

  @media (min-width: 640px) {
    .photo-card__download-mobile {
      display: none;
    }

    .photo-card__download-desktop {
      display: flex;
    }
  }

  /* Photo Lightbox */
  .photo-lightbox {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgb(0 0 0 / 0.95);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .photo-lightbox.open {
    opacity: 1;
    visibility: visible;
  }

  .photo-lightbox__close,
  .photo-lightbox__prev,
  .photo-lightbox__next {
    position: absolute;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgb(255 255 255 / 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .photo-lightbox__close:hover,
  .photo-lightbox__prev:hover,
  .photo-lightbox__next:hover {
    background: rgb(255 255 255 / 0.2);
  }

  .photo-lightbox__close { top: 1rem; right: 1rem; }
  .photo-lightbox__prev { left: 1rem; top: 50%; transform: translateY(-50%); }
  .photo-lightbox__next { right: 1rem; top: 50%; transform: translateY(-50%); }

  @media (min-width: 640px) {
    .photo-lightbox__close { top: 1.5rem; right: 1.5rem; }
    .photo-lightbox__prev { left: 1.5rem; }
    .photo-lightbox__next { right: 1.5rem; }
  }

  .photo-lightbox__content {
    max-width: 90vw;
    max-height: 80vh;
  }

  .photo-lightbox__image {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 0.5rem;
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .photo-lightbox.open .photo-lightbox__image {
    transform: scale(1);
  }

  .photo-lightbox__footer {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .photo-lightbox__counter {
    font-size: 0.875rem;
    color: rgb(255 255 255 / 0.7);
  }

  .photo-lightbox__download {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    background: rgb(255 255 255 / 0.15);
    border: 1px solid rgb(255 255 255 / 0.3);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .photo-lightbox__download:hover {
    background: rgb(255 255 255 / 0.25);
  }
</style>

<script>
  // Download file helper
  async function downloadFile(url: string, filename: string) {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      const blobUrl = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(blobUrl);
    } catch {
      window.open(url, '_blank');
    }
  }

  // Lightbox state
  let currentPhotoIndex = 0;
  let photoUrls: string[] = [];

  function openPhotoLightbox(index: number) {
    currentPhotoIndex = index;
    const lightbox = document.getElementById('photo-lightbox');
    const image = lightbox?.querySelector('.photo-lightbox__image') as HTMLImageElement;
    const counter = lightbox?.querySelector('.photo-lightbox__counter');
    const downloadBtn = lightbox?.querySelector('.photo-lightbox__download');

    if (lightbox && image && photoUrls[index]) {
      image.src = photoUrls[index];
      if (counter) counter.textContent = `${index + 1} / ${photoUrls.length}`;
      if (downloadBtn) {
        downloadBtn.setAttribute('data-url', photoUrls[index]);
        downloadBtn.setAttribute('data-filename', `event-photo-${index + 1}.jpg`);
      }
      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
  }

  function closePhotoLightbox() {
    const lightbox = document.getElementById('photo-lightbox');
    if (lightbox) {
      lightbox.classList.remove('open');
      document.body.style.overflow = '';
    }
  }

  function navigatePhotoLightbox(direction: number) {
    const newIndex = (currentPhotoIndex + direction + photoUrls.length) % photoUrls.length;
    openPhotoLightbox(newIndex);
  }

  function initMediaPage() {
    // Collect photo URLs
    photoUrls = Array.from(document.querySelectorAll('[data-photo-index]'))
      .map(el => el.getAttribute('data-full-url') || '');

    // Photo image click to expand
    document.querySelectorAll('.photo-card__image').forEach((btn) => {
      btn.addEventListener('click', () => {
        const card = btn.closest('[data-photo-index]');
        if (card) {
          const index = parseInt(card.getAttribute('data-photo-index') || '0', 10);
          openPhotoLightbox(index);
        }
      });
    });

    // Download buttons (mobile)
    document.querySelectorAll('.download-btn-mobile').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        e.preventDefault();
        const url = btn.getAttribute('data-url');
        const filename = btn.getAttribute('data-filename');
        if (url && filename) {
          const span = btn.querySelector('span');
          if (span) span.textContent = 'Downloading...';
          await downloadFile(url, filename);
          if (span) {
            span.textContent = 'Done!';
            setTimeout(() => {
              span.textContent = 'Download';
            }, 2000);
          }
        }
      });
    });

    // Download buttons (desktop)
    document.querySelectorAll('.photo-card__download-desktop').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const url = btn.getAttribute('data-url');
        const filename = btn.getAttribute('data-filename');
        if (url && filename) {
          btn.classList.add('downloading');
          await downloadFile(url, filename);
          btn.classList.remove('downloading');
        }
      });
    });

    // Lightbox controls
    document.querySelector('.photo-lightbox__close')?.addEventListener('click', closePhotoLightbox);
    document.querySelector('.photo-lightbox__prev')?.addEventListener('click', () => navigatePhotoLightbox(-1));
    document.querySelector('.photo-lightbox__next')?.addEventListener('click', () => navigatePhotoLightbox(1));

    // Lightbox download button
    document.querySelector('.photo-lightbox__download')?.addEventListener('click', async (e) => {
      const btn = e.currentTarget as HTMLElement;
      const url = btn.getAttribute('data-url');
      const filename = btn.getAttribute('data-filename');
      if (url && filename) {
        const span = btn.querySelector('span');
        if (span) span.textContent = 'Downloading...';
        await downloadFile(url, filename);
        if (span) {
          span.textContent = 'Downloaded!';
          setTimeout(() => {
            span.textContent = 'Download';
          }, 2000);
        }
      }
    });

    // Lightbox keyboard navigation
    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('photo-lightbox');
      if (!lightbox?.classList.contains('open')) return;

      if (e.key === 'Escape') closePhotoLightbox();
      if (e.key === 'ArrowLeft') navigatePhotoLightbox(-1);
      if (e.key === 'ArrowRight') navigatePhotoLightbox(1);
    });

    // Close lightbox on backdrop click
    document.getElementById('photo-lightbox')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget || (e.target as HTMLElement).classList.contains('photo-lightbox__content')) {
        closePhotoLightbox();
      }
    });
  }

  initMediaPage();
  document.addEventListener('astro:after-swap', initMediaPage);
</script>
